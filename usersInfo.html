<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="format-detection" content="telephone=no,email=no">
    <meta name="author" content="lonq">
    <meta name="copyright" content="lonq">
    <title>用户信息</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="js/swiper-4.4.1/dist/css/swiper.min.css" rel="stylesheet">
    <link href="js/dialog2-master/dist/css/dialog.css" rel="stylesheet">
    <script src="js/flexible.js"></script>
</head>

<body>

    <header>
        <nav class="navbar navbar-light">
            <ul class="navbar-left">
                <li><a href="usersCenter.html"><i class="iconfont-angleleft"></i></a></li>
            </ul>
            <h3 class="navbar-title">用户信息</h3>
        </nav>
    </header>

    <div class="list border-top border-bottom">
        <a class="item vertical-center item-avatar item-access" href="javascript:;" data-eleName="usersFace">
            <div class="item-body">
                <span>头像</span>
            </div>
            <div class="avatar clear-margin js-value js-usersface"></div>
            <div class="item-footer"></div>
        </a>
        <a class="item vertical-center" href="javascript:;">
            <div class="item-body">
                <span>用户名</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-usersname"></span>
            </div>
        </a>
        <a class="item vertical-center item-access js-edit" href="javascript:;" data-eletype="text" data-eleName="UsersPetName">
            <div class="item-body">
                <span>昵称</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-userspetname"></span>
            </div>
        </a>
        <a class="item vertical-center item-access js-edit" href="javascript:;" data-eletype="text" data-eleName="UsersEMail">
            <div class="item-body">
                <span>邮箱</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-usersemail"></span>
            </div>
        </a>
        <a class="item vertical-center" href="javascript:;">
            <div class="item-body">
                <span>注册时间</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-addtime"></span>
            </div>
        </a>
        <a class="item vertical-center" href="javascript:;">
            <div class="item-body">
                <span>最后一次登录</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-logindate"></span>
            </div>
        </a>
        <a class="item item-access js-edit" href="javascript:;" data-eletype="textarea" data-eleName="UsersSignature">
            <div class="item-body">
                <span>签名</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-userssignature"></span>
            </div>
        </a>
    </div>
    <!-- 上传头像 -->
    <div class="actionsheet user-face-actionsheet">
        <div class="actionsheet-title padding-horizontal">
            <i class="close iconfont-wrong"></i>
            <p class="text-center">设置头像</p>
        </div>
        <ul class="actionsheet-menu direction-column text-center">
            <li>图库<!-- <input type="file" accept="image/*" multiple> --></li>
            <li>照相机</li>
        </ul>
        <div class="actionsheet-cancel">取消</div>
    </div>

    <script src="js/zepto.min.js"></script>
    <script src="js/touch.min.js"></script>
    <script src="js/htmlutil.js"></script>
    <script src="js/zepto.cookie.min.js"></script>
    <script src="js/checkLogin.js"></script>
    <script src="js/dialog2-master/dist/js/dialog.min.js"></script>
    <script src="js/focusEnd.js"></script>
    <script src="js/common.js"></script>
    <script src="js/config.js"></script>

    <script type="text/javascript">
        //<![CDATA[
        var usersid = HtmlUtil.getCookie($.fn.cookie('LQCookies'), 'UsersID'); // 用户ID
        $(function () {
            // 插入正文
            getContent();
            // 生成表单
            $('.js-edit').on('click', function(){
                var $t = $(this);
                var eleType = $t.attr('data-eletype');
                var eleName = $t.attr('data-eleName');
                initForm($t, eleType, eleName);
            });
            // 关闭表单
            $(document).on('click', '.js-close-btn', function(){
                closeModal();
            });
            // 清除表单字符
            $(document).on('click', '.form-control-feedback.iconfont-wrongcircle', function(){
                var target = $(this).prev();
                target.val('').focus();
            });
            // 修改头像
            $('a[data-eleName="usersFace"]').on('click', function (e) {
                showActionSheet($('.user-face-actionsheet'));
            });
        });
        // 表单
        function initForm($ele, eleType, eleName) {
            var title = $ele.find('.item-body>span').text();
            var value = $ele.find('.item-footer>span').html();
            var html = '';
            html += '<div class="modal modal-form bg-gray" style="display: block;">' +
                    '<form class="form-classics" id="stepForm" name="stepForm" method="post">' +
                    '<header>' +
                    '<nav class="navbar navbar-light">' +
                    '<ul class="navbar-left">' +
                    '<li class="js-close-btn" data-dismiss="modal"><a href="javascript:;"><i class="iconfont-angleleft"></i></a></li>' +
                    '</ul>' +
                    '<h3 class="navbar-title">修改' + title + '</h3>' +
                    '<ul class="navbar-right">' +
                    '<li id="ok" onclick="saveForm(\'' + eleName + '\')"><span>确定</span></li>' +
                    '</ul>' +
                    '</nav>' +
                    '</header>' +
                    '<div class="item">' +
                    '<div class="item-body">';
            html += '<input type="hidden" name="UsersID" id="UsersID" value="' + usersid + '">';
            if (eleType == 'textarea') {
                html += '<textarea class="form-control" name="' + eleName + '" id="' + eleName + '" rows="3" placeholder="请输入' + title + '">' + value + '</textarea>';
            } else {
                html += '<input type="' + eleType + '" class="form-control" name="' + eleName + '" id="' + eleName + '" value="' + value + '" placeholder="请输入' + title + '">';
            }
            html += '<i class="form-control-feedback iconfont-wrongcircle text-muted"></i>' +
                    '<span class="help-block">昵称不能为空</span>' +
                    '</div>' +
                    '</div>' +
                    '</form>' +
                    '</div>';
            $('body').append(html);
            $('#' + eleName).focusEnd();
        }
        // 文章正文
        function getContent() {
            $.ajax({
                type: 'GET',
                url: 'getUsers.asp?Action=content',
                data: {
                    UsersID: usersid
                },
                timeout: 15000,
                dataType: 'json',
                success: function (reponse) {
                    // 有数据
                    var usersname = reponse.usersname;
                    var userspetname = reponse.userspetname;
                    var userssignature = reponse.userssignature;
                    var usersemail = reponse.usersemail;
                    var usersface = reponse.usersface;
                    var addtime = reponse.addtime;
                    var logindate = reponse.logindate;
                    if (usersface) {
                        usersface = usersface;
                    } else {
                        usersface = 'images/placeholder-avatar.jpg';
                    }
                    if (userspetname) {
                        userspetname = userspetname;
                    } else {
                        userspetname = usersname;
                    }
                    if (userssignature) {
                        userssignature = userssignature;
                    } else {
                        userssignature = '他很懒，什么都没留下。';
                    }
                    $('.js-usersface').html('<img src="' + usersface + '">');
                    $('.js-usersname').html(usersname);
                    $('.js-userspetname').html(userspetname);
                    $('.js-usersemail').html(usersemail);
                    $('.js-addtime').html(addtime);
                    $('.js-logindate').html(logindate);
                    $('.js-userssignature').html(userssignature);
                },
                error: function (xhr, type, errorThrown) {
                    // 加载失败
                }
            });
        }
        // 修改普通表单
        function validateForm($ele) {
            var $errorMsgObj = $(this).parent();
            if ($ele == 'UsersPetName') { // 验证昵称

                var nameVal = $.trim(this.value); //原生js去空格方式：this.replace(/(^\s*)|(\s*$)/g, "")
                var regName = /[~#^$@%&!*()<>:;'"{}【】  ]/;
                if(nameVal == "" || nameVal.length < 2 || regName.test(nameVal)){
                    var errorMsg = "昵称不能为空，长度2位以上，不包含特殊字符！";
                    //class='msg onError' 中间的空格是层叠样式的格式
                    $errorMsgObj.append("<span class='msg onError'>" + errorMsg + "</span>");
                }
                else{
                    var okMsg=" 输入正确";
                    $errorMsgObj.find(".high").remove();
                    $errorMsgObj.append("<span class='msg onSuccess'>" + okMsg + "</span>");
                }



            } else if ($ele == 'UsersEMail') {
                UsersEMail: $('#UsersEMail').val()
            } else if ($ele == 'UsersSignature') {
                UsersSignature: $('#UsersSignature').val()
            } else {
                return false;
            }
        }
        // 修改普通表单
        function saveForm($ele) {
            var value = $('#' + $ele).val();
            $.ajax({
                type: "POST",
                url: 'getUsers.asp?Action=update' + $ele,
                data: $('#stepForm').serialize(),
                timeout: 15000,
                dataType: "json",
                success: function (reponse) {
                    $('.js-' + $ele.toLowerCase()).html(value);
                    closeModal();
                },
                error: function () {
                    HtmlUtil.msg('错误！');
                }
            });
        }
        // 显示actionsheet
        function showActionSheet(actionsheet) {
            actionsheet.before('<div class="actionsheet-backdrop"></div>');
            var backdrop = $('.actionsheet-backdrop');
            var actionsheetCancel = $('.actionsheet-cancel, .actionsheet .close');
            backdrop.on('click', hideActionSheet);
            actionsheetCancel.on('click', hideActionSheet);
            actionsheet.addClass('actionsheet-toggle');
        }
        // 关闭actionsheet
        function hideActionSheet() {
            var actionsheet = $('.actionsheet');
            var backdrop = $('.actionsheet-backdrop');
            actionsheet.removeClass('actionsheet-toggle');
            backdrop.remove();
        }
        // 消息提示
        function closeModal() {
            $('.modal').remove();
        }
        // 消息提示
        function noData(type, text) {
            var color, icon;
            switch (type) {
                case 'primary':
                    color = 'msg msg-primary';
                    icon = 'icon iconfont-correctcircle';
                    break;
                default:
                    color = 'msg msg-default';
                    icon = 'icon iconfont-infocircle';
            }
            var str = '';
            str += '<div class="' + color + '">';
            str += '<h1><i class="' + icon + '"></i></h1>' +
                '<h3 class="text-center">' + text + '</h3>' +
                '</div>';
            targetObj.html(str);
        }
        //]]>
    </script>
</body>

</html>