<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="full-screen" content="yes">
    <meta name="x5-fullscreen" content="true">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="format-detection" content="telephone=no,email=no">
    <meta name="author" content="lonq">
    <meta name="copyright" content="lonq">
    <title>用户信息</title>
    <link href="js/dialog2-master/dist/css/dialog.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="js/flexible.js"></script>
</head>

<body>

    <header>
        <nav class="navbar navbar-light">
            <ul class="navbar-left">
                <li><a href="usersCenter.html"><i class="iconfont-angleleft"></i></a></li>
            </ul>
            <h3 class="navbar-title">用户信息</h3>
        </nav>
    </header>

    <div class="list items border-top border-bottom">
        <a class="item item-avatar item-access vertical-center js-userface-edit" href="javascript:;" data-eletype="text" data-eleName="usersFace">
            <div class="item-body">
                <span>头像</span>
            </div>
            <div class="avatar clear-margin">
                <div class="js-usersface"></div>
                <!-- <form class="form-classics" id="usersFaceForm" name="usersFaceForm" method="POST">
                    <input id="fileuplaod" name="fileuplaod" type="file" accept="image/*" onchange="">
                </form> -->
            </div>
            <div class="item-footer"></div>
        </a>
        <a class="item" href="javascript:;">
            <div class="item-body">
                <span>用户名</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-usersname"></span>
            </div>
        </a>
        <a class="item item-access js-edit" href="javascript:;" data-eletype="text" data-eleName="UsersPetName">
            <div class="item-body">
                <span>昵称</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-userspetname"></span>
            </div>
        </a>
        <a class="item item-access js-edit" href="javascript:;" data-eletype="text" data-eleName="UsersPhone">
            <div class="item-body">
                <span>手机号</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-usersphone"></span>
            </div>
        </a>
        <a class="item item-access js-edit" href="javascript:;" data-eletype="text" data-eleName="UsersEMail">
            <div class="item-body">
                <span>邮箱</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-usersemail"></span>
            </div>
        </a>
        <a class="item" href="javascript:;">
            <div class="item-body">
                <span>注册时间</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-addtime"></span>
            </div>
        </a>
        <a class="item" href="javascript:;">
            <div class="item-body">
                <span>最后一次登录</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-logindate"></span>
            </div>
        </a>
        <a class="item item-thumb item-access js-edit" href="javascript:;" data-eletype="textarea" data-eleName="UsersSignature">
            <div class="item-body">
                <span>签名</span>
            </div>
            <div class="item-footer item-note">
                <span class="js-value js-userssignature"></span>
            </div>
        </a>
    </div>
    <!-- 上传头像 -->
    <div class="actionsheet user-face-actionsheet">
        <div class="actionsheet-title padding-horizontal">
            <i class="close iconfont-wrong"></i>
            <p class="text-center">设置头像</p>
        </div>
        <ul class="actionsheet-menu direction-column text-center">
            <li>图库<input type="file" id="video" accept="video/*" capture="camcorder"></li>
            <li>照相机<input type="file" id="image" accept="image/*" capture="camera"></li>
        </ul>
        <div class="actionsheet-cancel">取消</div>
    </div>

    <script src="js/zepto.min.js"></script>
    <script src="js/touch.min.js"></script>
    <script src="js/htmlutil.js"></script>
    <script src="js/zepto.cookie.min.js"></script>
    <script src="js/checkLogin.js"></script>
    <script src="js/uploadFiles.js"></script>
    <script src="js/dialog2-master/dist/js/dialog.min.js"></script>
    <script src="js/focusEnd.js"></script>
    <script src="js/zepto-cut-photo-master/js/zepto.cutphoto.js"></script>
    <script src="js/common.js"></script>
    <script src="js/config.js"></script>

    <script type="text/javascript">
        //<![CDATA[
        var usersid = HtmlUtil.getCookie($.fn.cookie('LQCookies'), 'UsersID'); // 用户ID
        $(function () {
            // 插入正文
            getContent();
            // 生成头像表单
            $('.js-userface-edit').on('click', function(){
                var $t = $(this);
                var eleType = $t.attr('data-eletype');
                var eleName = $t.attr('data-eleName');
                initUserFaceForm($t, eleType, eleName);
            });
            // 生成表单
            $('.js-edit').on('click', function(){
                var $t = $(this);
                var eleType = $t.attr('data-eletype');
                var eleName = $t.attr('data-eleName');
                initForm($t, eleType, eleName);
            });
            // 关闭表单
            $(document).on('click', '.js-close-btn', function(){
                closeModal();
            });
        });
        // 表单
        function initForm($target, eleType, eleName) {
            var title = $target.find('.item-body>span').text();
            var value = $target.find('.item-footer>span').html();
            var html = '';
            html += '<div id="modalForm" class="modal modal-form bg-gray" style="display: block;">' +
                    '<form class="form-classics" id="stepForm" name="stepForm" onsubmit="return validateForm(\'' + eleName + '\')">' +
                    '<header>' +
                    '<nav class="navbar navbar-light">' +
                    '<ul class="navbar-left">' +
                    '<li class="js-close-btn" data-dismiss="modal"><a href="javascript:;"><i class="iconfont-angleleft"></i></a></li>' +
                    '</ul>' +
                    '<h3 class="navbar-title">修改' + title + '</h3>' +
                    '<ul class="navbar-right">' +
                    '<li id="ok" onclick="validateForm(\'' + eleName + '\')"><span>确定</span></li>' +
                    '</ul>' +
                    '</nav>' +
                    '</header>' +
                    '<div class="list items">' +
                    '<div class="item js-clear-value">' +
                    '<div class="item-body">';
            html += '<input type="hidden" name="UsersID" id="UsersID" value="' + usersid + '">';
            if (eleType == 'textarea') {
                html += '<textarea class="form-control js-clear-ele" name="' + eleName + '" id="' + eleName + '" rows="3" placeholder="请输入' + title + '">' + value + '</textarea>';
            } else {
                html += '<input type="' + eleType + '" class="form-control js-clear-ele" name="' + eleName + '" id="' + eleName + '" value="' + value + '" placeholder="请输入' + title + '">';
            }
            html += '</div>' +
                    '<div class="item-footer form-control-feedback">' +
                    '<i class="iconfont-wrongcircle text-muted js-clear-btn"></i>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="items-tips"></div>' +
                    '</form>' +
                    '</div>';
            $('body').append(html);
            $('#' + eleName).focusEnd();
            // 清除表单控件的值
            clearEleValue('.js-clear-value', '.js-clear-ele', '.js-clear-btn');
            // 初始化提示消息
            initMsg($('.items-tips'), eleName);
        }
        // 文章正文
        function getContent() {
            $.ajax({
                type: 'GET',
                url: 'getUsers.asp?Action=content',
                data: {
                    UsersID: usersid
                },
                timeout: 15000,
                dataType: 'json',
                success: function (reponse) {
                    // 有数据
                    var usersname = reponse.usersname;
                    var userspetname = reponse.userspetname;
                    var usersphone = reponse.usersphone;
                    var userssignature = reponse.userssignature;
                    var usersemail = reponse.usersemail;
                    var usersface = reponse.usersface;
                    var addtime = reponse.addtime;
                    var logindate = reponse.logindate;
                    if (usersface) {
                        usersface = usersface;
                    } else {
                        usersface = 'images/placeholder-avatar.jpg';
                    }
                    if (userspetname) {
                        userspetname = userspetname;
                    } else {
                        userspetname = usersname;
                    }
                    if (userssignature) {
                        userssignature = userssignature;
                    } else {
                        userssignature = '他很懒，什么都没留下。';
                    }
                    $('.js-usersface').html('<img src="' + usersface + '">');
                    $('.js-usersname').html(usersname);
                    $('.js-userspetname').html(userspetname);
                    $('.js-usersphone').html(usersphone);
                    $('.js-usersemail').html(usersemail);
                    $('.js-addtime').html(addtime);
                    $('.js-logindate').html(logindate);
                    $('.js-userssignature').html(userssignature);
                },
                error: function (xhr, type, errorThrown) {
                    // 加载失败
                    HtmlUtil.msg('错误！');
                }
            });
        }
        // 初始化表单提示
        function initMsg($target, eleName) {
            var $ele = $('#' + eleName);
            var _initMsg = '';
            if (eleName == 'UsersPetName') { // 昵称
                let len = 18;
                _initMsg = '昵称长度2-'+ len +'位，不包含特殊字符！';
                $ele.attr('maxlength', len);
            } else if (eleName == 'UsersPhone') { // 手机号
                let len = 11;
                _initMsg = '请输入正确的手机号，长度'+ len +'位。';
                $ele.attr('maxlength', len);
            } else if (eleName == 'UsersEMail') { // 邮箱
                _initMsg = '请输入正确的邮箱地址，例如：admin@163.com。';
            } else if (eleName == 'UsersSignature') { // 签名
                let len = 50;
                _initMsg = '选填项，最大长度'+ len +'位。';
                $ele.attr('maxlength', len);
            } else {
                _initMsg = '';
            }
            $target.html(_initMsg);
        }
        // 修改普通表单
        function validateForm(eleName) {
            var $ele = $('#' + eleName);
            var $errorMsgObj = $ele.parents('.items').siblings('.items-tips');
            var val = $.trim($ele.val());
            if (eleName == 'UsersPetName') { // 昵称
                let reg = /^[\u4e00-\u9fa5A-Za-z0-9-_]*$/;
                if(val == "" || val.length < 2 || val.length > 18 || !reg.test(val)){
                    var errorMsg = "昵称不能为空，长度2-18位，不包含特殊字符！";
                    $errorMsgObj.html("<span class='text-danger'>" + errorMsg + "</span>");
                    $ele.focus();
                    return false;
                }
            }
            if (eleName == 'UsersPhone') { // 手机号
                let reg = /^0?1[3|4|5|6|7|8][0-9]\d{8}$/;
                if(val == ""){
                    var errorMsg = "手机号不能为空！";
                    $errorMsgObj.html("<span class='text-danger'>" + errorMsg + "</span>");
                    $ele.focus();
                    return false;
                } else if(!reg.test(val)){
                    var errorMsg = "手机号格式错误！";
                    $errorMsgObj.html("<span class='text-danger'>" + errorMsg + "</span>");
                    $ele.focus();
                    return false;
                }
            }
            if (eleName == 'UsersEMail') { // 邮箱
                let reg = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
                if(val == ""){
                    var errorMsg = "邮箱不能为空！";
                    $errorMsgObj.html("<span class='text-danger'>" + errorMsg + "</span>");
                    $ele.focus();
                    return false;
                } else if(!reg.test(val)){
                    var errorMsg = "邮箱格式错误！";
                    $errorMsgObj.html("<span class='text-danger'>" + errorMsg + "</span>");
                    $ele.focus();
                    return false;
                }
            }
            saveForm(eleName);
        }
        // 修改普通表单
        function saveForm(eleName) {
            var val = $('#' + eleName).val();
            $.ajax({
                type: "POST",
                url: 'getUsers.asp?Action=update' + eleName,
                data: $('#stepForm').serialize(),
                timeout: 15000,
                dataType: "json",
                success: function (reponse) {
                    $('.js-' + eleName.toLowerCase()).html(val);
                    closeModal();
                },
                error: function () {
                    HtmlUtil.msg('错误！');
                }
            });
        }
        // 显示actionsheet
        function showActionSheet(actionsheet) {
            actionsheet.before('<div class="actionsheet-backdrop"></div>');
            var backdrop = $('.actionsheet-backdrop');
            var actionsheetCancel = $('.actionsheet-cancel, .actionsheet .close');
            backdrop.on('click', hideActionSheet);
            actionsheetCancel.on('click', hideActionSheet);
            actionsheet.addClass('actionsheet-toggle');
        }
        // 关闭actionsheet
        function hideActionSheet() {
            var actionsheet = $('.actionsheet');
            var backdrop = $('.actionsheet-backdrop');
            actionsheet.removeClass('actionsheet-toggle');
            backdrop.remove();
        }
        // 关闭模态框
        function closeModal() {
            $('.modal').remove();
        }
        //]]>
    </script>
</body>

</html>